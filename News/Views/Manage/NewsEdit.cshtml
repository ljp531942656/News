@using System.Data;
<div>
    <ul class="nav nav-tabs">
        <li class="active">
            <a>新闻管理</a>
        </li>
    </ul>
    <div>
        <div class="search btn-group col-lg-4">
            <select id="select1" class="btn btn2">
                <option value="title">标题</option>
                <option value="author">编辑</option>
                <option value="newstype">新闻类别</option>
            </select>
            <input id="input1" class="pull-left form-control"/>
            <select class="form-control mutiselect selectpicker show-tick" name="newstypeselect1" type="text" id="newstypeselect1" multiple data-live-search="false" data-show-content="true" data-none-selected-text="选择" data-actions-box="true" data-deselect-all-text="全不选" data-select-all-text="全选">
                <option value="社会动态">社会动态</option>
                <option value="金融财经">金融财经</option>
                <option value="激情体育">激情体育</option>
                <option value="科技前沿">科技前沿</option>
                <option value="汽车资讯">汽车资讯</option>
                <option value="房产">房产</option>
                <option value="军事">军事</option>
                <option value="娱乐">娱乐</option>
                <option value="健康">健康</option>
                <option value="其它">其它</option>
            </select>
            <button id="search1" class="btn btn3 btn-default">搜索</button>
        </div>

        <table id="table1" class="table table1 table-hover fixed-table-container">
            <thead>
                <tr>
                    <th width="6%">删除</th>
                    <th width="6%">编辑</th>
                    <th width="34%">标题</th>
                    <th width="24%">编辑</th>
                    <th width="10%">新闻类别</th>
                    <th id="th0" width="14%" class="asc">
                        日期
                        <span class="pull-right glyphicon glyphicon-sort tableGly"></span>
                    </th>
                    <th id="th1" width="6%" class="asc">
                        是否发布
                        <span class="pull-right glyphicon glyphicon-sort tableGly"></span>
                    </th>
                </tr>
            </thead>
            <tbody id="tbody1">

                @foreach (DataRow dr in (ViewData["NewsList"] as DataTable).Rows)
                {
                    <tr>
                        <td>
                            <a data-toggle="modal" data-target="#DeleteModal" newsid="@dr["id"]">删除</a>
                        </td>
                        <td>
                            <a newsid="@dr["id"]">编辑</a>
                        </td>
                        <td>@dr["title"]</td>
                        <td>@dr["author"]</td>
                        <td>@dr["newstype"]</td>
                        <td name="td0">@dr["date"]</td>
                        <td name="td1">@dr["isrelease"]</td>
                    </tr>
                }

            </tbody>
        </table>
        <div id="num1" class="col-lg-5 hidden">当前第<span id="nowpage1"></span>页&nbsp;&nbsp;&nbsp;共<span id="pagenum1"></span>页&nbsp;&nbsp;&nbsp;共<span id="contentnum1"></span>条内容</div>
        <div class="pull-right pagechange">
            <ul class="pagination" id="ampagination1"></ul>
        </div>
    </div>
</div>
<div class="modal fade" id="DeleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title" id="myModalLabel">删除</h4>
            </div>
            <div class="modal-body">是否删除这条新闻？</div>
            <div class="modal-footer">
                <button id="deletenewsbtn" type="button" data-dismiss="modal" class="btn btn-green">删除</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button class="hidden" id="deletenewssuccessbtn" data-toggle="modal" data-target="#DeleteSuccessModal"></button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>


<script type="text/javascript">
    $(document).ready(function () {
        $("#newstypeselect1").selectpicker();
        $("#newstypeselect1").selectpicker('setStyle', 'btn3', 'add');
        $("div.bootstrap-select").addClass("hidden");
        $("#select1").on("change",function () {
            if ($(this).val() == "newstype") {
                $("#input1").addClass("hidden");
                $("div.bootstrap-select").removeClass("hidden");
            }
            else {
                $("#input1").removeClass("hidden");
                $("div.bootstrap-select").addClass("hidden");
            }
        });
        spiltpage();
        var newsid = 0;
        var issearch = "false";
        var array = [[]];
        $("#table1>thead>tr>th").on("click", function () {
            iconChange(this.children);
            SortTable(this, issearch, array);
        });
        $("#tbody1>tr>td:first-child>a").on("click", function () {
            newsid = $(this).attr("newsid");
        });
        $("#deletenewsbtn").click(function () {
            Delete(newsid);
            $("div.modal-backdrop.fade.in").fadeOut(150);
        });

        $("#tbody1>tr>td:nth-child(2)>a").on("click", function () {
            newsid = $(this).attr("newsid");
            $("#Comiframe").html("<iframe id='Commontiframe' src='@Href("~/")Manage/Create?ISVIEW=true&NEWSID=" + newsid + "'></iframe>");
            $("#Comiframe").append('<img class="loading" src="@Href("~/")scripts/fileinput/img/loading-sm.gif" />');
            $("#Commontiframe").addClass("loadingback");
            $("#Comiframe").show();
            $("#Comiframeback").show();
            $("#Commontiframe").load(function () {
                $(this.contentWindow.document.getElementById("Newsiframe")).ready(function () {
                    var mainheight = $(this).contents().find("body").height() + 17;
                    $(this).height(mainheight);

                    $("#Commontiframe").removeClass("loadingback");
                    $("img.loading").fadeOut();
                });
            });
        });

        $("#search1").click(function () {
            $("#newsedit").append('<img class="loading" src="@Href("~/")scripts/fileinput/img/loading-sm.gif" />');
            $("#newsedit").addClass("loadingback");

            var tb = document.getElementById("tbody1");
            //前端搜索
            //search(tb, $("#select1").val(), $("#input1").val());
            var searchstr = "";
            if ($("#input1").hasClass("hidden")) {
                searchstr = $("#newstypeselect1").val();
            }
            else {
                searchstr = $("#input1").val();
            }
            array = searchinback("NewsPage", $("#select1").val(), searchstr, "newsedit");
            var rownum = tb.rows.length
            for (i = 0; i < rownum; i++) {
                tb.deleteRow(0);
            }
            for (var i = 0; i < array.length; i++) {
                var row = tb.insertRow(i);
                row.insertCell(0).innerHTML = '<a newsid="' + array[i][0] + '">删除</a>';
                row.insertCell(1).innerHTML = '<a newsid="' + array[i][0] + '">编辑</a>';
                row.insertCell(2).innerHTML = array[i][1];
                row.insertCell(3).innerHTML = array[i][2];
                row.insertCell(4).innerHTML = array[i][4];
                row.insertCell(5).innerHTML = array[i][5];
                row.insertCell(6).innerHTML = array[i][6];
            }
            $("#tbody1>tr>td:nth-child(6n)").attr("name", "td0");
            $("#tbody1>tr>td:nth-child(7n)").attr("name", "td1");
            spiltpage();
            if ($("#input1").val() != "") {
                issearch = "true";
            }
            else {
                issearch = "false";
            }
        });

    });

    //分页
    function spiltpage() {
        {
            var tb = document.getElementById("tbody1");
            var rownum = tb.rows.length;
            if (tb.rows.length > 16) {
                $("#num1").removeClass("hidden");
                $("#ampagination1").removeClass("hidden");
                var table = [];
                var allrownum = 0;
                if (rownum % 16 == 0) {
                    allrownum = rownum / 16;
                }
                else {
                    allrownum = parseInt(rownum / 16) + 1;
                }
                for (var i = 0; i < allrownum; i++) {
                    table.push([]);
                    for (var j = 16 * i; j < 16 * (i + 1) ; j++) {
                        if (typeof (tb.rows[j]) != "undefined") {
                            table[i].push(tb.rows[j].innerHTML);
                        }
                    }
                }
                for (i = 16; i < rownum; i++) {
                    tb.deleteRow(16);
                }
                $("#nowpage1").html("1");
                $("#pagenum1").html(allrownum);
                $("#contentnum1").html(rownum);
                $('#ampagination1').jqPaginator({
                    totalPages: allrownum,
                    visiblePages: 5,
                    currentPage: 1,

                    first: '<li class="first"><a href="javascript:void(0);">首页</a></li>',
                    prev: '<li class="prev"><a href="javascript:void(0);">上一页</a></li>',
                    next: '<li class="next"><a href="javascript:void(0);">下一页</a></li>',
                    last: '<li class="last"><a href="javascript:void(0);">尾页</a></li>',
                    page: '<li class="page"><a href="javascript:void(0);">{{page}}</a></li>',
                    onPageChange: function (num) {
                        $("#nowpage").html(num);
                        var tb = document.getElementById("tbody1");
                        rownum = tb.rows.length;
                        for (i = 0; i < rownum; i++) {
                            tb.deleteRow(0);
                        }
                        for (var i = 0; i < table[num - 1].length; i++) {
                            var row = tb.insertRow(i);
                            row.innerHTML = table[num - 1][i];
                        }
                    }
                });
            }
            else {
                $("#num1").addClass("hidden");
                $("#ampagination1").addClass("hidden");
            }

            $("img.loading").fadeOut();
            $("#newsedit").removeClass("loadingback");
        }
    }
    //列表排序
    function sortNumberAsc(a, b) {
        return trans(a) - trans(b);
    }
    function sortNumberDesc(a, b) {
        return trans(b) - trans(a);
    }
    function sortDateAsc(a, b) {
        if (a > b) {
            return 1;
        }
        else if (a == b) {
            return 0;
        }
        else if (a < b) {
            return -1;
        }
    }
    function sortDateDesc(a, b) {
        if (b > a) {
            return 1;
        }
        else if (b == a) {
            return 0;
        }
        else if (b < a) {
            return -1;
        }
    }
    function trans(str) {
        if (str == "是") {
            str = "1";
        }
        else if (str == "否") {
            str = "0";
        }
        else {

        }
        return str;
    }
    function SortTable(obj, issearch, array) {
        var tb = document.getElementById("tbody1");
        rownum = tb.rows.length;
        var sort = obj.className;
        if (issearch == "true") {
            for (i = 0; i < rownum; i++) {
                tb.deleteRow(0);
            }
            for (var i = 0; i < array.length; i++) {
                var row = tb.insertRow(i);
                row.insertCell(0).innerHTML = '<a newsid="' + array[i][0] + '">删除</a>';
                row.insertCell(1).innerHTML = '<a newsid="' + array[i][0] + '">编辑</a>';
                row.insertCell(2).innerHTML = array[i][1];
                row.insertCell(3).innerHTML = array[i][2];
                row.insertCell(4).innerHTML = array[i][4];
                row.insertCell(5).innerHTML = array[i][5];
                row.insertCell(6).innerHTML = array[i][6];
            }
            $("#tbody1>tr>td:nth-child(6n)").attr("name", "td0");
            $("#tbody1>tr>td:nth-child(7n)").attr("name", "td1");

            var td0s = document.getElementsByName("td0");
            var td1s = document.getElementsByName("td1");

            var tdArray0 = [];
            var tdArray1 = [];

            for (var i = 0; i < td0s.length; i++) {
                tdArray0.push(td0s[i].innerHTML);
            }
            for (var i = 0; i < td1s.length; i++) {
                tdArray1.push(td1s[i].innerHTML);
            }
            var tds = document.getElementsByName("td" + obj.id.substr(2, 1));
            var columnArray = [];

            for (var i = 0; i < tds.length; i++) {
                columnArray.push(tds[i].innerHTML);
            }


            var orginArray = [];
            for (var i = 0; i < columnArray.length; i++) {
                orginArray.push(columnArray[i]);
            }
            if (obj.className == "asc") {
                if (obj.id == "th0") {
                    columnArray.sort(sortDateAsc);
                }
                else {
                    columnArray.sort(sortNumberAsc); //排序后的新值
                }

                obj.className = "desc";
            } else {
                if (obj.id == "th0") {
                    columnArray.sort(sortDateDesc);
                }
                else {
                    columnArray.sort(sortNumberDesc);//排序后的新值
                }

                obj.className = "asc";
            }
            for (var i = 0; i < columnArray.length; i++) {
                for (var j = 0; j < orginArray.length; j++) {
                    if (orginArray[j] == columnArray[i]) {
                        document.getElementsByName("td0")[i].innerHTML = tdArray0[j];
                        document.getElementsByName("td1")[i].innerHTML = tdArray1[j];
                        orginArray[j] = null;
                        break;
                    }
                }
            }
            spiltpage();
        }
        else {
            var column;
            if (obj.id == "th0") {
                column = "date";
            }
            else {
                column = "isrelease";
            }
            $.ajax({
                url: '@Href("~/")Manage/sort',
                type: 'post',
                data: { sort: sort, type: 'newsedit', column: column },
                success: function (res) {
                    var tb = document.getElementById("tbody1");
                    var array = [[]];
                    array = res.sortlist;
                    var rownum = tb.rows.length
                    for (i = 0; i < rownum; i++) {
                        tb.deleteRow(0);
                    }
                    for (var i = 0; i < array.length; i++) {
                        var row = tb.insertRow(i);
                        row.insertCell(0).innerHTML = '<a newsid="' + array[i][0] + '">删除</a>';
                        row.insertCell(1).innerHTML = '<a newsid="' + array[i][0] + '">编辑</a>';
                        row.insertCell(2).innerHTML = array[i][1];
                        row.insertCell(3).innerHTML = array[i][2];
                        row.insertCell(4).innerHTML = array[i][4];
                        row.insertCell(5).innerHTML = array[i][5];
                        row.insertCell(6).innerHTML = array[i][6];
                    }
                    if (obj.className == "asc") {
                        obj.className = "desc";
                    } else {
                        obj.className = "asc";
                    }
                    spiltpage();
                }
            });
        }
    }
    function iconChange(obj) {

        if ($(obj).parent("th").hasClass("desc")) {
            $(obj).removeClass("glyphicon-sort-by-attributes").addClass("glyphicon-sort-by-attributes-alt");
            $(obj).parent("th").siblings("th").children("span").removeClass("glyphicon-sort-by-attributes").removeClass("glyphicon-sort-by-attributes-alt").addClass("glyphicon-sort");
        }
        else if ($(obj).parent("th").hasClass("asc")) {
            $(obj).removeClass("glyphicon-sort-by-attributes-alt").addClass("glyphicon-sort-by-attributes");
            $(obj).parent("th").siblings("th").children("span").removeClass("glyphicon-sort-by-attributes").removeClass("glyphicon-sort-by-attributes-alt").addClass("glyphicon-sort");
        }
        else if ($(obj).hasClass("glyphicon-sort")) {
            $(obj).removeClass("glyphicon-sort").addClass("glyphicon-sort-by-attributes");
            $(obj).parent("th").siblings("th").children("span").removeClass("glyphicon-sort-by-attributes").removeClass("glyphicon-sort-by-attributes-alt").addClass("glyphicon-sort");
        }
    }

    //列表删除编辑
    function Delete(newsid) {
        $.ajax({
            url: '@Href("~/")Manage/delete',
            data: { newsid: newsid },
            type: 'post',
            success: function (res) {
                if (res.msg == "success") {
                    $("#deletenewssuccessbtn").trigger("click");
                    $.ajax({
                        url: '../Manage/Newsedit',
                        success: function (res) {
                            $("#newsedit").html(res);
                            $("#newsedit").fadeIn().siblings("div").hide();
                        },
                    });
                }
            }
        });
    }
</script>

